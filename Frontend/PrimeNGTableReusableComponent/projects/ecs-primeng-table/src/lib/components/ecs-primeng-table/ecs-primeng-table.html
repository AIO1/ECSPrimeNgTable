<p-table #dt
    size="small" showGridlines stripedRows 
    sortMode="multiple"
    [resizableColumns]="true" columnResizeMode="expand"
    [reorderableColumns]="true"
    [scrollable]="true" [scrollHeight]="computeScrollHeight ? scrollHeight : ''"
    [columns]="columnsToShow" [value]="data" dataKey="rowID" 
    [lazy]="true" (onLazyLoad)="updateData($event)">

    <!-- TEMPLATE FOR THE PREDIFINED FILTERS -->
    <ng-template #predifinedFilterTemplate let-option="option" let-col="col" let-rowData="rowData">
        @if (option.icon) {
            <i [class]="option.icon" [style]="'vertical-align: middle; margin-right: 0.5rem; color: '+(option.iconColor || '') +';' +(option.iconStyle || '')"></i>
        }
        @if (!option.iconBlob && option.iconBlobSourceEndpoint) {
            <p-skeleton size="28px" style="vertical-align: middle; margin-right: 0.5rem;"/>
        }
        @if (option.iconBlob) {
            <img alt="iconBlob" [src]="getBlobIconAsUrl(option.iconBlob)" height="28" style="vertical-align: middle; margin-right: 0.5rem;"/>
        }
        @if (option.iconURL) {
            <img alt="iconFromURL" [src]="option.iconURL" height="28" style="vertical-align: middle; margin-right: 0.5rem;"/>
        }
        @if (option.displayTag === true) {
            <p-tag [style]="option.tagStyle" style="vertical-align: middle; margin-right: 0.5rem;">{{ option.name }}</p-tag>
        }
        @if (option.displayName === true) {
            <span style="margin-left: 0.25rem; margin-top: 0.25rem;">{{ option.name }}</span>
        }
    </ng-template>

    <!-- TEMPLATE FOR THE ACTIONS HEADER COLUMN -->
    <ng-template #actionColumnHeaderTemplate>
        @if (rowActionButtons.length > 0) {
            <th 
            [ngStyle]="{
                'max-width': actionsColumnWidth + 'px',
                'min-width': actionsColumnWidth + 'px',
                'width': actionsColumnWidth + 'px'
            }"
            pResizableColumn  [pResizableColumnDisabled]="!actionsColumnResizable" pFrozenColumn [frozen]="actionsColumnFrozen"
            [alignFrozen]="getFrozenColumnAlignAsText(actionsColumnAligmentRight ? FrozenColumnAlign.Right : FrozenColumnAlign.Left)"
            id="actions-header"  [attr.scope]="'col'" style="text-align: center;">
                {{ actionColumnName }}
            </th>
        }
    </ng-template>

    <!-- TEMPLATE FOR THE ACTIONS ROW COLUMN -->
    <ng-template #actionColumnTemplate let-rowData="rowData">
        @if (rowActionButtons.length > 0) {
            <td [ngStyle]="{
            'max-width': actionsColumnWidth + 'px', 
            'min-width': actionsColumnWidth + 'px', 
            'width': actionsColumnWidth + 'px'
            }"
            style="text-align: center; vertical-align: middle;" pFrozenColumn  [frozen]="actionsColumnFrozen" 
            [alignFrozen]="getFrozenColumnAlignAsText(actionsColumnAligmentRight ? FrozenColumnAlign.Right : FrozenColumnAlign.Left)">
            @for (button of rowActionButtons; track button) {
                <p-button 
                    [disabled]="button.condition ? !button.condition(rowData) : false"
                    [ngClass]="button.color || 'p-button-outlined'"
                    [icon]="button.icon || ''" 
                    [label]="button.label || ''" 
                    (onClick)="button.action && handleButtonsClick(button.action, rowData)" 
                    [pTooltip]="button.tooltip || ''" 
                    [showDelay]="700"
                    tooltipPosition="top"/>
            }
            </td>
        }
    </ng-template>

    <!-- TEMPLATE FOR THE ROW SELECTOR HEADER COLUMN -->
    <ng-template #rowSelectorColumnHeaderTemplate>
        <th 
            [ngStyle]="{
            'max-width': rowSelectorColumnWidth + 'px',
            'min-width': rowSelectorColumnWidth + 'px',
            'width': rowSelectorColumnWidth + 'px'
            }"
            id="rowSelector-header"  [attr.scope]="'col'" pResizableColumn [pResizableColumnDisabled]="!rowselectorColumnResizable" pFrozenColumn 
            [frozen]="rowSelectorColumnFrozen" [alignFrozen]="getFrozenColumnAlignAsText(rowSelectorColumnAligmentRight ? FrozenColumnAlign.Right : FrozenColumnAlign.Left)"
            style="text-align: center;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    {{ rowSelectorColumName }}
                    <p-columnFilter type="boolean" field="selector" display="menu" [showButtons]="false"></p-columnFilter>
                </div>
        </th>
    </ng-template>

    
    <!--TEMPLATE FOR THE ROW SELECTOR ROW COLUMN-->
    <ng-template #rowSelectorColumnTemplate let-rowData="rowData">
        <td 
        [ngStyle]="{
            'max-width': rowSelectorColumnWidth + 'px', 
            'min-width': rowSelectorColumnWidth + 'px', 
            'width': rowSelectorColumnWidth + 'px'
        }"
        style="text-align: center; vertical-align: middle;" pFrozenColumn [frozen]="rowSelectorColumnFrozen" 
        [alignFrozen]="getFrozenColumnAlignAsText(rowSelectorColumnAligmentRight ? FrozenColumnAlign.Right : FrozenColumnAlign.Left)">
        <p-checkbox 
            [binary]="true"
            [ngModel]="isRowSelected(rowData.rowID)"
            (onChange)="onRowSelectChange($event, rowData.rowID)"/>
        </td>
    </ng-template>


    <!-- LOGIC FOR DRAWING TABLE ACTIONS ABOVE THE HEADER -->
    <ng-template #caption>
        <div #headerContainer style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <!--CHOOSE COLUMNS TO SHOW-->
                @if (columnEditorEnabled) {
                    <p-button
                        icon="pi pi-info"
                        (onClick)="showColumnModal()"
                        pTooltip="Modify columns"
                        [showDelay]="700"
                        tooltipPosition="top"
                        styleClass="p-button-icon-only"
                    />
                }

                <!--CLEAR SORTS AND FILTERS-->
                @if (columnEditorEnabled) {
                    <p-button
                        icon="pi pi-sort-alt-slash"
                        (onClick)="clearSorts(dt)"
                        [disabled]="!hasToClearSorts(dt)"
                        pTooltip="Clear sorts"
                        [showDelay]="700"
                        tooltipPosition="top"
                        styleClass="p-button-icon-only"
                    />
                }
                @if (columnEditorEnabled) {
                    <p-button
                        icon="pi pi-filter-slash"
                        (onClick)="clearFilters(dt)"
                        [disabled]="!hasToClearFilters(dt, globalSearchText)"
                        pTooltip="Clear filters"
                        [showDelay]="700"
                        tooltipPosition="top"
                        styleClass="p-button-icon-only"
                    />
                }
            </div>

            <!--TABLE VIEWS-->
            <!--
            <div *ngIf="tableViewSaveAs !== enumTableViewSaveMode.noone && tableViewsFirstFetchDone===true && tableViewSaveKey !== ''" style="display: flex; align-items: center; gap: 10px;">
                <div class="p-inputgroup custom-inputgroup" 
                    style="display: flex; align-items: center;">
                    <div (click)="viewsModalShow=true; $event.stopPropagation();" style="cursor: pointer; display: flex; align-items: center; padding: 0 10px;">
                        <input
                            type="text"
                            pInputText
                            [value]="tableViewCurrentSelectedAlias ? tableViewCurrentSelectedAlias : '--- Select a view ---'"
                            readonly
                            style="background-color: transparent; border: none; flex-grow: 1; pointer-events: none;"
                            [style.font-style]="tableViewCurrentSelectedAlias ? 'normal' : 'italic'"/>
                    </div>
                    <div class="vertical-separator"></div>
                    <button pButton 
                        pTooltip="Apply view again"
                        tooltipPosition="top"
                        [showDelay]="700"
                        type="button" icon="pi pi-refresh" (click)="loadTableView()"
                        class="p-button custom-refresh-button" style="cursor: pointer; height: 100%; padding: 0;" [disabled]="!hasLoadView()">
                    </button>
                    <button pButton 
                        pTooltip="Reset table view to original"
                        tooltipPosition="top"
                        [showDelay]="700"
                        type="button" icon="pi pi-eraser" (click)="resetTableView()"
                        class="p-button custom-refresh-button" style="cursor: pointer; height: 100%; padding: 0;">
                    </button>
                </div>
            </div>
            -->

            <div style="display: flex; align-items: center; gap: 10px;">
                <!--GLOBAL FILTER-->
                @if (globalSearchEnabled) {
                    <p-iconField iconPosition="left" class="ml-auto" [ngClass]="{'p-input-icon-right': globalSearchText}">
                        <!-- Icono izquierda -->
                        <p-inputIcon>
                            <i class="pi pi-search"></i>
                        </p-inputIcon>
                        <!-- Campo de texto -->
                        <input 
                            pInputText 
                            type="text" 
                            (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                            autocomplete="off" 
                            [maxlength]="globalSearchMaxLength"
                            [placeholder]="globalSearchPlaceholder"
                            [(ngModel)]="globalSearchText"
                            style="width: 220px;"
                        />
                        <!-- Icono derecha solo si hay texto -->
                        @if (globalSearchText) {
                            <p-inputIcon position="right">
                                <i 
                                    class="pi pi-times" 
                                    style="cursor: pointer;" 
                                    (click)="clearFilters(dt, true, true); $event.stopPropagation()">
                                </i>
                            </p-inputIcon>
                        }
                    </p-iconField>
                }

                <!--EXPORT DATA-->
                @if (reportSourceURL && reportSourceURL.trim().length > 0) {
                    <p-button
                        icon="pi pi-file-excel"
                        (onClick)="openExcelReport()"
                        pTooltip="Export to Excel"
                        [showDelay]="700"
                        tooltipPosition="top"
                        styleClass="p-button-icon-only"
                    />
                }

                <!--REFRESH DATA-->
                @if (showRefreshData) {
                    <p-button
                        icon="pi pi-refresh"
                        (onClick)="updateData($event)"
                        pTooltip="Refresh data"
                        [showDelay]="700"
                        tooltipPosition="top"
                        styleClass="p-button-icon-only"
                    />
                }
                
                <!-- HEADER ACTION BUTTONS -->
                @if (headerActionButtons.length > 0) {
                    <td style="display: flex; justify-content: center; align-items: center;">
                        @for (button of headerActionButtons; track $index) {
                        <p-button
                            [disabled]="button.condition ? !button.condition(null) : false"
                            [pTooltip]="button.tooltip || ''"
                            [tooltipDisabled]="!button.tooltip || button.tooltip.length === 0"
                            [showDelay]="700"
                            tooltipPosition="top"
                            [styleClass]="button.color"
                            [icon]="button.icon || ''"
                            [label]="button.label || ''"
                            (onClick)="button.action && handleButtonsClick(button.action, null)"/>
                        }
                    </td>
                }
            </div>
        </div>
    </ng-template>

    <!-- LOGIC FOR DRAWING TABLE HEADERS -->
    <ng-template #header let-columns>
        <tr>
            @if (!actionsColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="actionColumnHeaderTemplate"></ng-container>
            }
            @if (rowSelectorColumnActive && !rowSelectorColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="rowSelectorColumnHeaderTemplate"></ng-container>
            }
            @for (col of columns; track col.header) {
                <th [ngStyle]="getColumnStyle(col, true)"
                    pResizableColumn [pResizableColumnDisabled]="!col.canBeResized ? true : false"
                    pReorderableColumn [pReorderableColumnDisabled]="!col.canBeReordered ? true : false"
                    pFrozenColumn [frozen]="col.frozenColumnAlign === FrozenColumnAlign.Left || col.frozenColumnAlign === FrozenColumnAlign.Right" [alignFrozen]="getFrozenColumnAlignAsText(col.frozenColumnAlign)"
                    [pSortableColumn]="col.field" [pSortableColumnDisabled]="!col.canBeSorted ? true : false"
                    style="text-align: center;"
                    [id]="col.field + '-header'" [attr.scope]="'col'">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span>{{ col.header }}</span>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            @if (col.canBeSorted) {
                                <p-sortIcon [field]="col.field"></p-sortIcon>
                            }
                            @if(col.canBeFiltered){
                                @if (!col.filterPredifinedValuesName || col.filterPredifinedValuesName.length === 0) {
                                    <p-columnFilter [type]="getDataTypeAsText(col.dataType)" [field]="col.field" display="menu" [showButtons]="false"/>
                                } @else {
                                    <p-columnFilter
                                        type="{{getDataTypeAsText(col.dataType)}}" field="{{col.field}}" display="menu"
                                        [showButtons]="false" matchMode="in" operator="or" [showMatchModes]="false"
                                        [showOperator]="false" [showAddButton]="false" [showClearButton]="false" [showApplyButton]="false">
                                        <ng-template #filter>
                                            <p-multiSelect
                                                [style]="{ minWidth: '400px' }" [(ngModel)]="predifinedFiltersSelectedValuesCollection[col.filterPredifinedValuesName]"
                                                [options]="getPredifinedFilterValues(col.filterPredifinedValuesName)" [placeholder]="predifinedFiltersNoSelectionPlaceholder"
                                                (onChange)="onPredifinedFilterChange(col.field, $event.value)" optionLabel="name">
                                                    <ng-template #selectedItems>
                                                    @if (predifinedFiltersSelectedValuesCollection[col.filterPredifinedValuesName].length > 0) {
                                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                            <div>
                                                                {{predifinedFiltersSelectedValuesText(col.filterPredifinedValuesName)}}
                                                            </div>
                                                        </div>
                                                    } @else {
                                                        <div>{{ predifinedFiltersNoSelectionPlaceholder }}</div>
                                                    }
                                                    </ng-template>
                                                    <ng-template let-option pTemplate="item">
                                                        <div style="display: inline-block; vertical-align: middle;">
                                                            <ng-container *ngTemplateOutlet="predifinedFilterTemplate; context: { option: option, col: col, rowData: '' }"></ng-container>
                                                        </div>
                                                    </ng-template>
                                            </p-multiSelect>
                                        </ng-template>
                                    </p-columnFilter>
                                }
                            }
                            @if (col.columnDescription && col.columnDescription.length > 0) {
                                <i [pTooltip]="col.columnDescription" tooltipPosition="top" class="pi pi-info-circle"></i>
                            }
                        </div>
                    </div>
                </th>
            }
            @if (rowSelectorColumnActive && rowSelectorColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="rowSelectorColumnHeaderTemplate"></ng-container>
            }
            @if (actionsColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="actionColumnHeaderTemplate"></ng-container>
            }
        </tr>
    </ng-template>

    <!-- LOGIC FOR DRAWING TABLE DATA WHEN THERE IS CONTENTS -->
    <ng-template #body let-rowData let-columns="columns"> 
        <tr>
            @if (!actionsColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="actionColumnTemplate" [ngTemplateOutletContext]="{ rowData: rowData }"></ng-container>
            }
            @if (rowSelectorColumnActive && !rowSelectorColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="rowSelectorColumnTemplate" [ngTemplateOutletContext]="{ rowData: rowData }"></ng-container>
            }
            @for (col of columns; track col.field) {
                <td (mousedown)="col.dataType !== DataType.Boolean && copyToClipboardStart($event)" (mouseup)="copyToClipboardCancel()"
                    [ngStyle]="getColumnStyle(col)" pFrozenColumn [frozen]="col.frozenColumnAlign === FrozenColumnAlign.Left || col.frozenColumnAlign === FrozenColumnAlign.Right" 
                    [alignFrozen]="getFrozenColumnAlignAsText(col.frozenColumnAlign)" [style.text-align]="getDataAlignHorizontalAsText(col.dataAlignHorizontal)" [style.vertical-align]="getDataAlignVerticalAsText(col.dataAlignVertical)">
                    @if (rowData[col.field] !== null) {
                        @if (col.filterPredifinedValuesName && col.filterPredifinedValuesName.length > 0) {
                            <div
                                [ngStyle]="{
                                    'display': 'flex',
                                    'justify-content': getDataAlignHorizontalAsText(col.dataAlignHorizontal),
                                    'align-items': getDataAlignVerticalAsText(col.dataAlignVertical)
                                }">
                                @if (getPredfinedFilterMatch(col, rowData[col.field]); as option) {
                                    <div 
                                        [pTooltip]="col.dataTooltipCustomColumnSource && col.dataTooltipCustomColumnSource.length > 0 
                                            ? rowData[col.dataTooltipCustomColumnSource] 
                                            : rowData[col.field]"
                                        [tooltipDisabled]="!col.dataTooltipShow"
                                        [showDelay]="700"
                                        tooltipPosition="top">
                                        <ng-container [ngTemplateOutlet]="predifinedFilterTemplate" [ngTemplateOutletContext]="{ option: option, col: col, rowData: rowData }"></ng-container>
                                    </div>
                                }
                            </div>
                        }
                        @else {
                            @switch (col.dataType) {
                                @case (DataType.Boolean) {
                                    <i class="pi"
                                        [pTooltip]="col.dataTooltipCustomColumnSource && col.dataTooltipCustomColumnSource.length > 0 
                                            ? rowData[col.dataTooltipCustomColumnSource] 
                                            : rowData[col.field]"  
                                        [tooltipDisabled]="!col.dataTooltipShow || !col.dataTooltipCustomColumnSource || col.dataTooltipCustomColumnSource.length === 0"
                                        [showDelay]="700"
                                        tooltipPosition="top"
                                        [style.color]="rowData[col.field] ? 'green' : 'red'"
                                        [ngClass]="{ 'pi-check-circle': rowData[col.field], 'pi-times-circle': !rowData[col.field] }"
                                    ></i>
                                }
                                @case (DataType.Date) {
                                    <div [innerHtml]="highlightText(formatDate(rowData[col.field]), col, globalSearchText)"
                                        [pTooltip]="col.dataTooltipCustomColumnSource && col.dataTooltipCustomColumnSource.length > 0 
                                            ? rowData[col.dataTooltipCustomColumnSource] 
                                            : formatDate(rowData[col.field])" 
                                        [tooltipDisabled]="!col.dataTooltipShow" [showDelay]="700" tooltipPosition="top">
                                        {{ formatDate(rowData[col.field]) }}
                                    </div>
                                }
                                @default {
                                    <div 
                                        [innerHtml]="highlightText(rowData[col.field], col, globalSearchText)"
                                        [pTooltip]="col.dataTooltipCustomColumnSource && col.dataTooltipCustomColumnSource.length > 0 
                                            ? rowData[col.dataTooltipCustomColumnSource] 
                                            : rowData[col.field]"
                                        [tooltipDisabled]="!col.dataTooltipShow"
                                        [showDelay]="700"
                                        tooltipPosition="top"
                                    >
                                        {{ rowData[col.field] }}
                                    </div>
                                }
                            }
                        }
                    }
                    @else {
                        <ng-template #nullContent>
                            <!-- Content for null cases, by default, don't draw anything -->
                        </ng-template>
                    }
                </td>
            }
            @if (rowSelectorColumnActive && rowSelectorColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="rowSelectorColumnTemplate" [ngTemplateOutletContext]="{ rowData: rowData }"></ng-container>
            }
            @if (actionsColumnAligmentRight) {
                <ng-container [ngTemplateOutlet]="actionColumnTemplate" [ngTemplateOutletContext]="{ rowData: rowData }"></ng-container>
            }
        </tr>
    </ng-template>

    <!-- LOGIC FOR DRAWING TABLE DATA WHEN THERE IS NO CONTENTS -->
    <ng-template #emptymessage>
        <tr>
            <td colspan="999">No data found.</td>
        </tr>
    </ng-template>

    <!-- LOGIC FOR DRAWING PAGINATION -->
    <ng-template #summary>
    </ng-template>
</p-table>